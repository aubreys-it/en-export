
name: build-push-deploy-aca (Az)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  RG: rg-en-export
  ENV: enexport-aca-env
  APP: enexport-app
  ACR_NAME: enexportacr123

jobs:
  build-push-deploy:
    runs-on: ubuntu-latest

    permissions:
      id-token: write      # required for OIDC
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Login to Azure using OIDC; enables Az cmdlets in subsequent steps
      - name: Azure login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          enable-AzPSSession: true   # prepares Az PowerShell session for later steps

      - name: Get ACR login server (Az PowerShell)
        uses: azure/powershell@v1
        with:
          azPSVersion: "10.0"
          inlineScript: |
            $acr = Get-AzContainerRegistry -ResourceGroupName $env:RG -Name $env:ACR_NAME
            "loginServer=$($acr.LoginServer)" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: ACR login for Docker (Az PowerShell)
        uses: azure/powershell@v1
        with:
          azPSVersion: "10.0"
          inlineScript: |
            Connect-AzContainerRegistry -Name $env:ACR_NAME
      # Connect-AzContainerRegistry sets Docker creds to push/pull. [1](https://dev.to/latzo/automating-azure-project-setup-with-powershell-and-github-actions-572f)

      - name: Build & Push image (single-step version)
        uses: azure/powershell@v1
        with:
          azPSVersion: "10.0"
          inlineScript: |
            $acr = Get-AzContainerRegistry -ResourceGroupName $env:RG -Name $env:ACR_NAME
            $loginServer = $acr.LoginServer
            $tag = (Get-Date -Format 'yyyyMMdd-HHmm')
            $image = "$loginServer/en-export-func:$tag"
            Write-Host "Building $image"
            docker build -t "$image" .
            docker push "$image"
            "IMAGE=$image" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
            "ACR_SERVER=$loginServer" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
      
      - name: Update image via ARM PATCH (token + Invoke-RestMethod w/ audience fallback)
        uses: azure/powershell@v1
        with:
          azPSVersion: "10.0"
          inlineScript: |
            $ErrorActionPreference = "Stop"

            if (-not $env:IMAGE) { throw "IMAGE is not set." }
            if (-not $env:RG)    { throw "RG is not set." }
            if (-not $env:APP)   { throw "APP is not set." }

            # Ensure the right subscription context
            $sub = (Get-AzContext).Subscription.Id
            if ([string]::IsNullOrWhiteSpace($sub)) { $sub = $env:AZURE_SUBSCRIPTION_ID }
            if ([string]::IsNullOrWhiteSpace($sub)) { throw "Subscription Id is not available in the Az context." }
            Select-AzSubscription -SubscriptionId $sub | Out-Null

            $apiVersion   = "2023-05-01"
            $resourcePath = "/subscriptions/$sub/resourceGroups/$($env:RG)/providers/Microsoft.App/containerApps/$($env:APP)"

            # Build URI safely
            $ub = [System.UriBuilder]::new("https://management.azure.com$resourcePath")
      
      - name: Wait for revision to become Ready (Azure CLI, resilient)
        shell: bash
        env:
          SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
        run: |
          set -euo pipefail

          APP="${APP:?APP env is required}"
          RG="${RG:?RG env is required}"

          # Ensure CLI is pointing at the right subscription
          az account set --subscription "$SUBSCRIPTION_ID"

          # --- 1) Resolve a revision name (retry for up to 3 minutes) ---
          echo "Resolving revision name to wait on..."
          RESOLVE_DEADLINE=$((SECONDS + 180))
          REV=""

          while [ -z "${REV}" ] || [ "${REV}" = "None" ]; do
            # Try the app's latestRevisionName first
            REV="$(az containerapp show -n "$APP" -g "$RG" --query properties.latestRevisionName -o tsv || true)"

            if [ -z "${REV}" ] || [ "${REV}" = "None" ]; then
              # Fall back to listing revisions; pick the newest by createdTime
              REV="$(az containerapp revision list -n "$APP" -g "$RG" \
                      --query "max_by([].{n:name, t:properties.createdTime}, &t).n" -o tsv || true)"
            fi

            if [ -z "${REV}" ] || [ "${REV}" = "None" ]; then
              if [ $SECONDS -gt $RESOLVE_DEADLINE ]; then
                echo "ERROR: Could not resolve a revision to wait on (latestRevisionName empty and list returned none)."
                echo "App (raw):"
                az containerapp show -n "$APP" -g "$RG" -o json || true
                echo "Revisions (raw):"
                az containerapp revision list -n "$APP" -g "$RG" -o json || true
                exit 1
              fi
              echo "Revision not visible yet. Sleeping 5s and retrying..."
              sleep 5
            fi
          done

          echo "Resolved revision: $REV"

          # --- 2) Poll that specific revision's provisioningState ---
          DEADLINE=$((SECONDS + 600))   # 10 minutes max; adjust if your image is large
          while true; do
            STATE="$(az containerapp revision show -n "$APP" -g "$RG" --revision "$REV" \
                      --query properties.provisioningState -o tsv || true)"
            RUNNING="$(az containerapp revision show -n "$APP" -g "$RG" --revision "$REV" \
                      --query properties.runningStatus -o tsv || true)"

            echo "Revision $REV  provisioningState=${STATE:-<unknown>}  runningStatus=${RUNNING:-<unknown>}"

            if [ "$STATE" = "Succeeded" ]; then
              echo "Revision $REV is Ready."
              break
            fi

            if [ $SECONDS -gt $DEADLINE ]; then
              echo "ERROR: Timeout waiting for revision $REV to become Ready."
              echo "Dumping revision details for diagnostics:"
              az containerapp revision show -n "$APP" -g "$RG" --revision "$REV" -o json || true
              exit 1
            fi

            sleep 10
          done
